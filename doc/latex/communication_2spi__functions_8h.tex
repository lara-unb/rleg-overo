\hypertarget{communication_2spi__functions_8h}{\section{communication/spi\-\_\-functions.h File Reference}
\label{communication_2spi__functions_8h}\index{communication/spi\-\_\-functions.\-h@{communication/spi\-\_\-functions.\-h}}
}
{\ttfamily \#include $<$stdint.\-h$>$}\\*
{\ttfamily \#include $<$unistd.\-h$>$}\\*
{\ttfamily \#include $<$stdio.\-h$>$}\\*
{\ttfamily \#include $<$stdlib.\-h$>$}\\*
{\ttfamily \#include $<$getopt.\-h$>$}\\*
{\ttfamily \#include $<$fcntl.\-h$>$}\\*
{\ttfamily \#include $<$sys/ioctl.\-h$>$}\\*
{\ttfamily \#include $<$linux/types.\-h$>$}\\*
{\ttfamily \#include $<$linux/spi/spidev.\-h$>$}\\*
Include dependency graph for spi\-\_\-functions.\-h\-:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{communication_2spi__functions_8h__incl}
\end{center}
\end{figure}
This graph shows which files directly or indirectly include this file\-:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{communication_2spi__functions_8h__dep__incl}
\end{center}
\end{figure}
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{communication_2spi__functions_8h_a25f003de16c08a4888b69f619d70f427}{A\-R\-R\-A\-Y\-\_\-\-S\-I\-Z\-E}(a)~(sizeof(a) / sizeof((a)\mbox{[}0\mbox{]}))
\item 
\#define \hyperlink{communication_2spi__functions_8h_ac10b0f18ed2164776ad6843aa7908592}{E\-N\-C\-O\-D\-E\-R\-\_\-\-N\-O\-\_\-\-O\-P}~0x00
\item 
\#define \hyperlink{communication_2spi__functions_8h_a24e6c0e05e904b10f56ae184da9e2aca}{E\-N\-C\-O\-D\-E\-R\-\_\-\-R\-D\-\_\-\-P\-O\-S}~0x10
\item 
\#define \hyperlink{communication_2spi__functions_8h_aa2fec4e0eb5a7b3668158a57952b9dbe}{E\-N\-C\-O\-D\-E\-R\-\_\-\-S\-E\-T\-\_\-\-Z\-E\-R\-O\-\_\-\-P\-T}~0x70
\item 
\#define \hyperlink{communication_2spi__functions_8h_ab815abd4b9b825c60dbb04aad0d0e846}{E\-N\-C\-O\-D\-E\-R\-\_\-\-E\-E\-P\-R\-O\-M\-\_\-\-W\-R}~0x80
\item 
\#define \hyperlink{communication_2spi__functions_8h_aa3f0b6d222591f8f7332f74106eaa0ca}{E\-N\-C\-O\-D\-E\-R\-\_\-\-E\-E\-P\-R\-O\-M\-\_\-\-R\-D}~0x90
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
int \hyperlink{communication_2spi__functions_8h_a70764aca888e93b0329e7a62c9312704}{spi\-\_\-init} (uint8\-\_\-t mode, uint32\-\_\-t speed, uint8\-\_\-t cs)
\begin{DoxyCompactList}\small\item\em spi Functions to deal communication by S\-P\-I protocol \end{DoxyCompactList}\item 
void \hyperlink{communication_2spi__functions_8h_a3fb02c6fc5990df81645306a81291624}{spi\-\_\-end} (int \hyperlink{CommunicationV0_2communication_8c_a4788f0a5355494bc6c13690e28f43783}{spi\-\_\-dev})
\begin{DoxyCompactList}\small\item\em T\-E\-R\-M\-I\-N\-A\-T\-E\-S S\-P\-I D\-E\-V\-I\-C\-E. \end{DoxyCompactList}\item 
int \hyperlink{communication_2spi__functions_8h_ae385345c227d9f67ab490b94ed628988}{adc\-\_\-read} (int \hyperlink{CommunicationV0_2communication_8c_a4788f0a5355494bc6c13690e28f43783}{spi\-\_\-dev}, uint8\-\_\-t ch, uint8\-\_\-t sgl, short int $\ast$data)
\begin{DoxyCompactList}\small\item\em R\-E\-A\-D D\-A\-T\-A F\-R\-O\-M A/\-D C\-O\-N\-V\-E\-R\-T\-E\-R M\-C\-P3208. \end{DoxyCompactList}\item 
int \hyperlink{communication_2spi__functions_8h_a5c52e64c336d59215ce0a4b6f340dc9f}{dac\-\_\-write} (int \hyperlink{CommunicationV0_2communication_8c_a4788f0a5355494bc6c13690e28f43783}{spi\-\_\-dev}, uint8\-\_\-t ch, uint8\-\_\-t \-\_\-shdn, unsigned short int data)
\begin{DoxyCompactList}\small\item\em W\-R\-I\-T\-E D\-A\-T\-A T\-O D/\-A C\-O\-N\-V\-E\-R\-T\-E\-R M\-C\-P3922. \end{DoxyCompactList}\item 
int \hyperlink{communication_2spi__functions_8h_a3ae450d2b3ece27bb6036f811a7625a9}{spi\-\_\-trans\-\_\-bytes} (int \hyperlink{CommunicationV0_2communication_8c_a4788f0a5355494bc6c13690e28f43783}{spi\-\_\-dev}, uint8\-\_\-t $\ast$send, uint8\-\_\-t $\ast$receive, int n)
\begin{DoxyCompactList}\small\item\em T\-R\-A\-N\-S\-F\-E\-R N B\-Y\-T\-E\-S. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Macro Definition Documentation}
\hypertarget{communication_2spi__functions_8h_a25f003de16c08a4888b69f619d70f427}{\index{communication/spi\-\_\-functions.\-h@{communication/spi\-\_\-functions.\-h}!A\-R\-R\-A\-Y\-\_\-\-S\-I\-Z\-E@{A\-R\-R\-A\-Y\-\_\-\-S\-I\-Z\-E}}
\index{A\-R\-R\-A\-Y\-\_\-\-S\-I\-Z\-E@{A\-R\-R\-A\-Y\-\_\-\-S\-I\-Z\-E}!communication/spi_functions.h@{communication/spi\-\_\-functions.\-h}}
\subsubsection[{A\-R\-R\-A\-Y\-\_\-\-S\-I\-Z\-E}]{\setlength{\rightskip}{0pt plus 5cm}\#define A\-R\-R\-A\-Y\-\_\-\-S\-I\-Z\-E(
\begin{DoxyParamCaption}
\item[{}]{a}
\end{DoxyParamCaption}
)~(sizeof(a) / sizeof((a)\mbox{[}0\mbox{]}))}}\label{communication_2spi__functions_8h_a25f003de16c08a4888b69f619d70f427}


Definition at line 29 of file spi\-\_\-functions.\-h.



Referenced by adc\-\_\-read(), and dac\-\_\-write().

\hypertarget{communication_2spi__functions_8h_aa3f0b6d222591f8f7332f74106eaa0ca}{\index{communication/spi\-\_\-functions.\-h@{communication/spi\-\_\-functions.\-h}!E\-N\-C\-O\-D\-E\-R\-\_\-\-E\-E\-P\-R\-O\-M\-\_\-\-R\-D@{E\-N\-C\-O\-D\-E\-R\-\_\-\-E\-E\-P\-R\-O\-M\-\_\-\-R\-D}}
\index{E\-N\-C\-O\-D\-E\-R\-\_\-\-E\-E\-P\-R\-O\-M\-\_\-\-R\-D@{E\-N\-C\-O\-D\-E\-R\-\_\-\-E\-E\-P\-R\-O\-M\-\_\-\-R\-D}!communication/spi_functions.h@{communication/spi\-\_\-functions.\-h}}
\subsubsection[{E\-N\-C\-O\-D\-E\-R\-\_\-\-E\-E\-P\-R\-O\-M\-\_\-\-R\-D}]{\setlength{\rightskip}{0pt plus 5cm}\#define E\-N\-C\-O\-D\-E\-R\-\_\-\-E\-E\-P\-R\-O\-M\-\_\-\-R\-D~0x90}}\label{communication_2spi__functions_8h_aa3f0b6d222591f8f7332f74106eaa0ca}


Definition at line 36 of file spi\-\_\-functions.\-h.

\hypertarget{communication_2spi__functions_8h_ab815abd4b9b825c60dbb04aad0d0e846}{\index{communication/spi\-\_\-functions.\-h@{communication/spi\-\_\-functions.\-h}!E\-N\-C\-O\-D\-E\-R\-\_\-\-E\-E\-P\-R\-O\-M\-\_\-\-W\-R@{E\-N\-C\-O\-D\-E\-R\-\_\-\-E\-E\-P\-R\-O\-M\-\_\-\-W\-R}}
\index{E\-N\-C\-O\-D\-E\-R\-\_\-\-E\-E\-P\-R\-O\-M\-\_\-\-W\-R@{E\-N\-C\-O\-D\-E\-R\-\_\-\-E\-E\-P\-R\-O\-M\-\_\-\-W\-R}!communication/spi_functions.h@{communication/spi\-\_\-functions.\-h}}
\subsubsection[{E\-N\-C\-O\-D\-E\-R\-\_\-\-E\-E\-P\-R\-O\-M\-\_\-\-W\-R}]{\setlength{\rightskip}{0pt plus 5cm}\#define E\-N\-C\-O\-D\-E\-R\-\_\-\-E\-E\-P\-R\-O\-M\-\_\-\-W\-R~0x80}}\label{communication_2spi__functions_8h_ab815abd4b9b825c60dbb04aad0d0e846}


Definition at line 35 of file spi\-\_\-functions.\-h.

\hypertarget{communication_2spi__functions_8h_ac10b0f18ed2164776ad6843aa7908592}{\index{communication/spi\-\_\-functions.\-h@{communication/spi\-\_\-functions.\-h}!E\-N\-C\-O\-D\-E\-R\-\_\-\-N\-O\-\_\-\-O\-P@{E\-N\-C\-O\-D\-E\-R\-\_\-\-N\-O\-\_\-\-O\-P}}
\index{E\-N\-C\-O\-D\-E\-R\-\_\-\-N\-O\-\_\-\-O\-P@{E\-N\-C\-O\-D\-E\-R\-\_\-\-N\-O\-\_\-\-O\-P}!communication/spi_functions.h@{communication/spi\-\_\-functions.\-h}}
\subsubsection[{E\-N\-C\-O\-D\-E\-R\-\_\-\-N\-O\-\_\-\-O\-P}]{\setlength{\rightskip}{0pt plus 5cm}\#define E\-N\-C\-O\-D\-E\-R\-\_\-\-N\-O\-\_\-\-O\-P~0x00}}\label{communication_2spi__functions_8h_ac10b0f18ed2164776ad6843aa7908592}


Definition at line 32 of file spi\-\_\-functions.\-h.

\hypertarget{communication_2spi__functions_8h_a24e6c0e05e904b10f56ae184da9e2aca}{\index{communication/spi\-\_\-functions.\-h@{communication/spi\-\_\-functions.\-h}!E\-N\-C\-O\-D\-E\-R\-\_\-\-R\-D\-\_\-\-P\-O\-S@{E\-N\-C\-O\-D\-E\-R\-\_\-\-R\-D\-\_\-\-P\-O\-S}}
\index{E\-N\-C\-O\-D\-E\-R\-\_\-\-R\-D\-\_\-\-P\-O\-S@{E\-N\-C\-O\-D\-E\-R\-\_\-\-R\-D\-\_\-\-P\-O\-S}!communication/spi_functions.h@{communication/spi\-\_\-functions.\-h}}
\subsubsection[{E\-N\-C\-O\-D\-E\-R\-\_\-\-R\-D\-\_\-\-P\-O\-S}]{\setlength{\rightskip}{0pt plus 5cm}\#define E\-N\-C\-O\-D\-E\-R\-\_\-\-R\-D\-\_\-\-P\-O\-S~0x10}}\label{communication_2spi__functions_8h_a24e6c0e05e904b10f56ae184da9e2aca}


Definition at line 33 of file spi\-\_\-functions.\-h.

\hypertarget{communication_2spi__functions_8h_aa2fec4e0eb5a7b3668158a57952b9dbe}{\index{communication/spi\-\_\-functions.\-h@{communication/spi\-\_\-functions.\-h}!E\-N\-C\-O\-D\-E\-R\-\_\-\-S\-E\-T\-\_\-\-Z\-E\-R\-O\-\_\-\-P\-T@{E\-N\-C\-O\-D\-E\-R\-\_\-\-S\-E\-T\-\_\-\-Z\-E\-R\-O\-\_\-\-P\-T}}
\index{E\-N\-C\-O\-D\-E\-R\-\_\-\-S\-E\-T\-\_\-\-Z\-E\-R\-O\-\_\-\-P\-T@{E\-N\-C\-O\-D\-E\-R\-\_\-\-S\-E\-T\-\_\-\-Z\-E\-R\-O\-\_\-\-P\-T}!communication/spi_functions.h@{communication/spi\-\_\-functions.\-h}}
\subsubsection[{E\-N\-C\-O\-D\-E\-R\-\_\-\-S\-E\-T\-\_\-\-Z\-E\-R\-O\-\_\-\-P\-T}]{\setlength{\rightskip}{0pt plus 5cm}\#define E\-N\-C\-O\-D\-E\-R\-\_\-\-S\-E\-T\-\_\-\-Z\-E\-R\-O\-\_\-\-P\-T~0x70}}\label{communication_2spi__functions_8h_aa2fec4e0eb5a7b3668158a57952b9dbe}


Definition at line 34 of file spi\-\_\-functions.\-h.



\subsection{Function Documentation}
\hypertarget{communication_2spi__functions_8h_ae385345c227d9f67ab490b94ed628988}{\index{communication/spi\-\_\-functions.\-h@{communication/spi\-\_\-functions.\-h}!adc\-\_\-read@{adc\-\_\-read}}
\index{adc\-\_\-read@{adc\-\_\-read}!communication/spi_functions.h@{communication/spi\-\_\-functions.\-h}}
\subsubsection[{adc\-\_\-read}]{\setlength{\rightskip}{0pt plus 5cm}int adc\-\_\-read (
\begin{DoxyParamCaption}
\item[{int}]{spi\-\_\-dev, }
\item[{uint8\-\_\-t}]{ch, }
\item[{uint8\-\_\-t}]{sgl, }
\item[{short int $\ast$}]{data}
\end{DoxyParamCaption}
)}}\label{communication_2spi__functions_8h_ae385345c227d9f67ab490b94ed628988}


R\-E\-A\-D D\-A\-T\-A F\-R\-O\-M A/\-D C\-O\-N\-V\-E\-R\-T\-E\-R M\-C\-P3208. 


\begin{DoxyParams}{Parameters}
{\em ch} & Set Channel (0 .. 7) \\
\hline
{\em sgl} & (0\-: to single or 1\-: to pseudo-\/differencial) \\
\hline
\end{DoxyParams}


Definition at line 172 of file spi\-\_\-functions.\-c.



References A\-R\-R\-A\-Y\-\_\-\-S\-I\-Z\-E, delay, F\-A\-I\-L\-U\-R\-E, and S\-U\-C\-C\-E\-S\-S.



Referenced by read\-\_\-all\-\_\-data().


\begin{DoxyCode}
173 \{
174         \textcolor{keywordtype}{int} ret;
175         \textcolor{keywordflow}{if}( ch<0 || ch>7 ) \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_a6d58f9ac447476b4e084d7ca383f5183}{FAILURE};
176         uint8\_t tx[] = \{(ch>>1)|(sgl<<2)|0x08, ch<<7, 0x00,\};
177         \textcolor{keyword}{union }rxunion\{
178           int8\_t rxs[\hyperlink{communication_2spi__functions_8h_a25f003de16c08a4888b69f619d70f427}{ARRAY\_SIZE}(tx)];
179           uint8\_t rx[\hyperlink{communication_2spi__functions_8h_a25f003de16c08a4888b69f619d70f427}{ARRAY\_SIZE}(tx)];
180         \}rxunion;
181         \textcolor{comment}{//rxunion.rx=\{0, \};}
182         \textcolor{keyword}{struct }spi\_ioc\_transfer tr = \{
183                 .tx\_buf = (\textcolor{keywordtype}{unsigned} long)tx,
184                 .rx\_buf = (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long})rxunion.rx,
185                 .len = \hyperlink{communication_2spi__functions_8h_a25f003de16c08a4888b69f619d70f427}{ARRAY\_SIZE}(tx),
186                 .delay\_usecs = \hyperlink{communication_2spi__functions_8c_adc4674f6ea53803d98fa2ec36759e77d}{delay},
187                 .speed\_hz = 0,
188                 .bits\_per\_word = 0,
189         \};
190 
191         ret = ioctl(\hyperlink{CommunicationV0_2communication_8c_a4788f0a5355494bc6c13690e28f43783}{spi\_dev}, SPI\_IOC\_MESSAGE(1), &tr);
192         \textcolor{keywordflow}{if} (ret == 1) \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_a6d58f9ac447476b4e084d7ca383f5183}{FAILURE};
193 \textcolor{comment}{//printf("\(\backslash\)nRx = 0x%X 0x%X 0x%X\(\backslash\)n",rx[0],rx[1],rx[2]);}
194 \textcolor{comment}{//printf("\(\backslash\)nValor retornado pelo conversor AD: %d\(\backslash\)n\(\backslash\)n",rx[2]+((rx[1]&0x0F)<<8));}
195         \textcolor{comment}{//*data=(short int)(rx[2]+((rxs[1]&0x1F)<<8));}
196         *data=(\textcolor{keywordtype}{short} int)(rxunion.rx[2]+( (int8\_t)( ((int8\_t)(rxunion.rxs[1]&0x1F)) <<3)<<5));
197         \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_aa90cac659d18e8ef6294c7ae337f6b58}{SUCCESS};
198 \}
\end{DoxyCode}


Here is the caller graph for this function\-:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{communication_2spi__functions_8h_ae385345c227d9f67ab490b94ed628988_icgraph}
\end{center}
\end{figure}


\hypertarget{communication_2spi__functions_8h_a5c52e64c336d59215ce0a4b6f340dc9f}{\index{communication/spi\-\_\-functions.\-h@{communication/spi\-\_\-functions.\-h}!dac\-\_\-write@{dac\-\_\-write}}
\index{dac\-\_\-write@{dac\-\_\-write}!communication/spi_functions.h@{communication/spi\-\_\-functions.\-h}}
\subsubsection[{dac\-\_\-write}]{\setlength{\rightskip}{0pt plus 5cm}int dac\-\_\-write (
\begin{DoxyParamCaption}
\item[{int}]{spi\-\_\-dev, }
\item[{uint8\-\_\-t}]{ch, }
\item[{uint8\-\_\-t}]{\-\_\-shdn, }
\item[{unsigned short int}]{data}
\end{DoxyParamCaption}
)}}\label{communication_2spi__functions_8h_a5c52e64c336d59215ce0a4b6f340dc9f}


W\-R\-I\-T\-E D\-A\-T\-A T\-O D/\-A C\-O\-N\-V\-E\-R\-T\-E\-R M\-C\-P3922. 



Definition at line 200 of file spi\-\_\-functions.\-c.


\begin{DoxyCode}
201 \{
202         \textcolor{keywordtype}{int} ret;
203         \textcolor{keyword}{union }txunion\{
204         \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} \textcolor{keywordtype}{int} data16;
205         uint8\_t data8[2];
206         \}txunion;
207         \textcolor{keywordflow}{if}( ch<0 || ch>1 ) \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_a6d58f9ac447476b4e084d7ca383f5183}{FAILURE};\textcolor{comment}{//pabort("Wrong channel value for DAC");}
208         \textcolor{keywordflow}{if}( data>4095 ) \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_a6d58f9ac447476b4e084d7ca383f5183}{FAILURE};\textcolor{comment}{//pabort("Value exceeded for DAC"); }
209         txunion.data16 = 0x6000|(ch<<15)|(\_shdn<<12)|(data&0x0FFF);
210         uint8\_t tx[] = \{txunion.data8[1], txunion.data8[0]\};
211         uint8\_t rx[\hyperlink{communication_2spi__functions_8h_a25f003de16c08a4888b69f619d70f427}{ARRAY\_SIZE}(tx)] = \{0, \};
212         \textcolor{keyword}{struct }spi\_ioc\_transfer tr = \{
213                 .tx\_buf = (\textcolor{keywordtype}{unsigned} long)tx,
214                 .rx\_buf = (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long})rx,
215                 .len = \hyperlink{communication_2spi__functions_8h_a25f003de16c08a4888b69f619d70f427}{ARRAY\_SIZE}(tx),
216                 .delay\_usecs = \hyperlink{communication_2spi__functions_8c_adc4674f6ea53803d98fa2ec36759e77d}{delay},
217                 .speed\_hz = 0,
218                 .bits\_per\_word = 0,
219         \};
220 
221         ret = ioctl(\hyperlink{CommunicationV0_2communication_8c_a4788f0a5355494bc6c13690e28f43783}{spi\_dev}, SPI\_IOC\_MESSAGE(1), &tr);
222         \textcolor{keywordflow}{if} (ret == 1) \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_a6d58f9ac447476b4e084d7ca383f5183}{FAILURE};\textcolor{comment}{//pabort("can't send spi message");}
223 \textcolor{comment}{//printf("\(\backslash\)nRx = 0x%X 0x%X 0x%X\(\backslash\)n",rx[0],rx[1],rx[2]);}
224 \textcolor{comment}{//printf("\(\backslash\)nValor retornado pelo conversor AD: %d\(\backslash\)n\(\backslash\)n",rx[2]+((rx[1]&0x0F)<<8));}
225         \textcolor{keywordflow}{return} 1;
226 \}
\end{DoxyCode}
\hypertarget{communication_2spi__functions_8h_a3fb02c6fc5990df81645306a81291624}{\index{communication/spi\-\_\-functions.\-h@{communication/spi\-\_\-functions.\-h}!spi\-\_\-end@{spi\-\_\-end}}
\index{spi\-\_\-end@{spi\-\_\-end}!communication/spi_functions.h@{communication/spi\-\_\-functions.\-h}}
\subsubsection[{spi\-\_\-end}]{\setlength{\rightskip}{0pt plus 5cm}void spi\-\_\-end (
\begin{DoxyParamCaption}
\item[{int}]{spi\-\_\-dev}
\end{DoxyParamCaption}
)}}\label{communication_2spi__functions_8h_a3fb02c6fc5990df81645306a81291624}


T\-E\-R\-M\-I\-N\-A\-T\-E\-S S\-P\-I D\-E\-V\-I\-C\-E. 



Definition at line 166 of file spi\-\_\-functions.\-c.


\begin{DoxyCode}
167 \{
168   close(\hyperlink{CommunicationV0_2communication_8c_a4788f0a5355494bc6c13690e28f43783}{spi\_dev});
169   \textcolor{keywordflow}{return};
170 \}
\end{DoxyCode}
\hypertarget{communication_2spi__functions_8h_a70764aca888e93b0329e7a62c9312704}{\index{communication/spi\-\_\-functions.\-h@{communication/spi\-\_\-functions.\-h}!spi\-\_\-init@{spi\-\_\-init}}
\index{spi\-\_\-init@{spi\-\_\-init}!communication/spi_functions.h@{communication/spi\-\_\-functions.\-h}}
\subsubsection[{spi\-\_\-init}]{\setlength{\rightskip}{0pt plus 5cm}int spi\-\_\-init (
\begin{DoxyParamCaption}
\item[{uint8\-\_\-t}]{mode, }
\item[{uint32\-\_\-t}]{speed, }
\item[{uint8\-\_\-t}]{cs}
\end{DoxyParamCaption}
)}}\label{communication_2spi__functions_8h_a70764aca888e93b0329e7a62c9312704}


spi Functions to deal communication by S\-P\-I protocol 

I\-N\-I\-T\-I\-A\-L\-I\-Z\-E S\-P\-I D\-E\-V\-I\-C\-E 

Definition at line 100 of file spi\-\_\-functions.\-c.


\begin{DoxyCode}
101 \{
102         \textcolor{keywordtype}{int} ret = 0;
103         \textcolor{keywordtype}{int} \hyperlink{CommunicationV0_2communication_8c_a4788f0a5355494bc6c13690e28f43783}{spi\_dev};
104         \textcolor{keywordtype}{char} *device;
105 
106         \textcolor{comment}{//parse\_opts(argc, argv);}
107         \textcolor{comment}{/*}
108 \textcolor{comment}{         * chose chipselect:}
109 \textcolor{comment}{         */}
110         \textcolor{keywordflow}{switch}(cs)\{
111           \textcolor{keywordflow}{case} 0:
112             device = \textcolor{stringliteral}{"/dev/spidev1.0"};
113             \textcolor{keywordflow}{break};
114           \textcolor{keywordflow}{case} 1:
115             device = \textcolor{stringliteral}{"/dev/spidev1.1"};
116             \textcolor{keywordflow}{break};
117           \textcolor{keywordflow}{default}:
118             \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{pabort}(\textcolor{stringliteral}{"invalid chip select value"});
119         \}
120             
121         
122         spi\_dev = open(device, O\_RDWR);
123         \textcolor{keywordflow}{if} (spi\_dev < 0)
124                 \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{pabort}(\textcolor{stringliteral}{"can't open device"});
125 \textcolor{comment}{//printf("\(\backslash\)nspi\_dev = %d\(\backslash\)n",spi\_dev);}
126         \textcolor{comment}{/*}
127 \textcolor{comment}{         * spi mode}
128 \textcolor{comment}{         */}
129         ret = ioctl(spi\_dev, SPI\_IOC\_WR\_MODE, &mode);
130         \textcolor{keywordflow}{if} (ret == -1)
131                 \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{pabort}(\textcolor{stringliteral}{"can't set spi mode"});
132 
133         ret = ioctl(spi\_dev, SPI\_IOC\_RD\_MODE, &mode);
134         \textcolor{keywordflow}{if} (ret == -1)
135                 \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{pabort}(\textcolor{stringliteral}{"can't get spi mode"});
136 
137         \textcolor{comment}{/*}
138 \textcolor{comment}{         * bits per word}
139 \textcolor{comment}{         */}
140         ret = ioctl(spi\_dev, SPI\_IOC\_WR\_BITS\_PER\_WORD, &\hyperlink{communication_2spi__functions_8c_a46a6da6b1936191571fd30b2a749f38c}{bits});
141         \textcolor{keywordflow}{if} (ret == -1)
142                 \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{pabort}(\textcolor{stringliteral}{"can't set bits per word"});
143 
144         ret = ioctl(spi\_dev, SPI\_IOC\_RD\_BITS\_PER\_WORD, &\hyperlink{communication_2spi__functions_8c_a46a6da6b1936191571fd30b2a749f38c}{bits});
145         \textcolor{keywordflow}{if} (ret == -1)
146                 \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{pabort}(\textcolor{stringliteral}{"can't get bits per word"});
147 
148         \textcolor{comment}{/*}
149 \textcolor{comment}{         * max speed hz}
150 \textcolor{comment}{         */}
151         ret = ioctl(spi\_dev, SPI\_IOC\_WR\_MAX\_SPEED\_HZ, &speed);
152         \textcolor{keywordflow}{if} (ret == -1)
153                 \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{pabort}(\textcolor{stringliteral}{"can't set max speed hz"});
154 
155         ret = ioctl(spi\_dev, SPI\_IOC\_RD\_MAX\_SPEED\_HZ, &speed);
156         \textcolor{keywordflow}{if} (ret == -1)
157                 \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{pabort}(\textcolor{stringliteral}{"can't get max speed hz"});
158 
159         \textcolor{comment}{//printf("spi mode: %d\(\backslash\)n", mode);}
160         \textcolor{comment}{//printf("bits per word: %d\(\backslash\)n", bits);}
161         \textcolor{comment}{//printf("max speed: %d Hz (%d KHz)\(\backslash\)n", speed, speed/1000);}
162 
163         \textcolor{keywordflow}{return} \hyperlink{CommunicationV0_2communication_8c_a4788f0a5355494bc6c13690e28f43783}{spi\_dev};
164 \}
\end{DoxyCode}
\hypertarget{communication_2spi__functions_8h_a3ae450d2b3ece27bb6036f811a7625a9}{\index{communication/spi\-\_\-functions.\-h@{communication/spi\-\_\-functions.\-h}!spi\-\_\-trans\-\_\-bytes@{spi\-\_\-trans\-\_\-bytes}}
\index{spi\-\_\-trans\-\_\-bytes@{spi\-\_\-trans\-\_\-bytes}!communication/spi_functions.h@{communication/spi\-\_\-functions.\-h}}
\subsubsection[{spi\-\_\-trans\-\_\-bytes}]{\setlength{\rightskip}{0pt plus 5cm}int spi\-\_\-trans\-\_\-bytes (
\begin{DoxyParamCaption}
\item[{int}]{spi\-\_\-dev, }
\item[{uint8\-\_\-t $\ast$}]{send, }
\item[{uint8\-\_\-t $\ast$}]{receive, }
\item[{int}]{n}
\end{DoxyParamCaption}
)}}\label{communication_2spi__functions_8h_a3ae450d2b3ece27bb6036f811a7625a9}


T\-R\-A\-N\-S\-F\-E\-R N B\-Y\-T\-E\-S. 



Definition at line 228 of file spi\-\_\-functions.\-c.



References delay, and F\-A\-I\-L\-U\-R\-E.



Referenced by enc\-\_\-read\-\_\-pos(), enc\-\_\-wait\-\_\-for\-\_\-ack(), and enc\-\_\-zero\-\_\-set().


\begin{DoxyCode}
228                                                                       \{
229 
230          \textcolor{comment}{//< define send data }
231         uint8\_t *tx;
232         tx = send;
233         uint8\_t rx[n]; 
234         rx[0] = 0;
235 
236         \textcolor{comment}{/*}
237 \textcolor{comment}{        * Transmitting data (full duplex):}
238 \textcolor{comment}{        */}
239         \textcolor{keyword}{struct }spi\_ioc\_transfer tr = \{
240                 .tx\_buf = (\textcolor{keywordtype}{unsigned} long)tx,
241                 .rx\_buf = (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long})rx,
242                 .len = n,
243                 .delay\_usecs = \hyperlink{communication_2spi__functions_8c_adc4674f6ea53803d98fa2ec36759e77d}{delay},
244                 .speed\_hz = 0,
245                 .bits\_per\_word = 0,
246         \};
247         \textcolor{keywordtype}{int} ret = ioctl(\hyperlink{CommunicationV0_2communication_8c_a4788f0a5355494bc6c13690e28f43783}{spi\_dev}, SPI\_IOC\_MESSAGE(1), &tr);
248 
249         \textcolor{comment}{//Check transmittion:}
250         \textcolor{keywordflow}{if}(ret == 1) \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_a6d58f9ac447476b4e084d7ca383f5183}{FAILURE};\textcolor{comment}{//pabort("can't send spi message");}
251 
252         *receive = rx[0];\textcolor{comment}{//get the received data}
253 
254         \textcolor{keywordflow}{return} 1;
255 \}
\end{DoxyCode}


Here is the caller graph for this function\-:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{communication_2spi__functions_8h_a3ae450d2b3ece27bb6036f811a7625a9_icgraph}
\end{center}
\end{figure}


