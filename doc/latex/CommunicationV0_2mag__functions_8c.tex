\hypertarget{CommunicationV0_2mag__functions_8c}{\section{Communication\-V0/mag\-\_\-functions.c File Reference}
\label{CommunicationV0_2mag__functions_8c}\index{Communication\-V0/mag\-\_\-functions.\-c@{Communication\-V0/mag\-\_\-functions.\-c}}
}
{\ttfamily \#include \char`\"{}imu\-\_\-functions.\-h\char`\"{}}\\*
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
int \hyperlink{CommunicationV0_2mag__functions_8c_ab5d0ae421cd4bb10b1b7a1eda167416b}{mag\-\_\-write\-\_\-reg} (int \hyperlink{CommunicationV0_2communication_8c_a7751bd45ac1064efb35adf1f19c25db8}{i2c\-\_\-dev}, uint8\-\_\-t reg, uint8\-\_\-t data)
\begin{DoxyCompactList}\small\item\em W\-R\-I\-T\-E T\-O R\-E\-G\-I\-S\-T\-E\-R. \end{DoxyCompactList}\item 
uint8\-\_\-t $\ast$ \hyperlink{CommunicationV0_2mag__functions_8c_a6830eaeae2298320e1e8c902e4edd709}{mag\-\_\-read\-\_\-reg} (int \hyperlink{CommunicationV0_2communication_8c_a7751bd45ac1064efb35adf1f19c25db8}{i2c\-\_\-dev}, uint8\-\_\-t reg, uint8\-\_\-t count)
\begin{DoxyCompactList}\small\item\em R\-E\-A\-D C\-O\-U\-N\-T 8-\/\-B\-I\-T R\-E\-G\-I\-S\-T\-E\-R I\-N S\-E\-Q\-U\-E\-N\-C\-E. \end{DoxyCompactList}\item 
int \hyperlink{CommunicationV0_2mag__functions_8c_a014f908c9faa37c1ec75177a17012a01}{mag\-\_\-init} (int \hyperlink{CommunicationV0_2communication_8c_a7751bd45ac1064efb35adf1f19c25db8}{i2c\-\_\-dev}, uint8\-\_\-t rate, uint8\-\_\-t range, uint8\-\_\-t samples\-\_\-avg, uint8\-\_\-t meas\-\_\-mode, uint8\-\_\-t op\-\_\-mode)
\begin{DoxyCompactList}\small\item\em I\-N\-I\-T\-I\-A\-L\-I\-Z\-E M\-A\-G\-N\-E\-T\-O\-M\-E\-T\-E\-R. \end{DoxyCompactList}\item 
uint8\-\_\-t \hyperlink{CommunicationV0_2mag__functions_8c_a8f2fd896caf1216ba82e535e6251692f}{mag\-\_\-read\-\_\-all\-\_\-data} (int \hyperlink{CommunicationV0_2communication_8c_a7751bd45ac1064efb35adf1f19c25db8}{i2c\-\_\-dev}, short int $\ast$data)
\begin{DoxyCompactList}\small\item\em R\-E\-A\-D A\-L\-L D\-A\-T\-A A\-T O\-N\-C\-E (X, Y and Z) \end{DoxyCompactList}\item 
short int \hyperlink{CommunicationV0_2mag__functions_8c_a542a31ccd07cd2c3e8e2b68cdb6d219e}{mag\-\_\-read\-\_\-data} (int \hyperlink{CommunicationV0_2communication_8c_a7751bd45ac1064efb35adf1f19c25db8}{i2c\-\_\-dev}, int axis)
\begin{DoxyCompactList}\small\item\em R\-E\-A\-D D\-A\-T\-A (X, Y or Z) \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Function Documentation}
\hypertarget{CommunicationV0_2mag__functions_8c_a014f908c9faa37c1ec75177a17012a01}{\index{Communication\-V0/mag\-\_\-functions.\-c@{Communication\-V0/mag\-\_\-functions.\-c}!mag\-\_\-init@{mag\-\_\-init}}
\index{mag\-\_\-init@{mag\-\_\-init}!CommunicationV0/mag_functions.c@{Communication\-V0/mag\-\_\-functions.\-c}}
\subsubsection[{mag\-\_\-init}]{\setlength{\rightskip}{0pt plus 5cm}int mag\-\_\-init (
\begin{DoxyParamCaption}
\item[{int}]{i2c\-\_\-dev, }
\item[{uint8\-\_\-t}]{rate, }
\item[{uint8\-\_\-t}]{range, }
\item[{uint8\-\_\-t}]{samples\-\_\-avg, }
\item[{uint8\-\_\-t}]{meas\-\_\-mode, }
\item[{uint8\-\_\-t}]{op\-\_\-mode}
\end{DoxyParamCaption}
)}}\label{CommunicationV0_2mag__functions_8c_a014f908c9faa37c1ec75177a17012a01}


I\-N\-I\-T\-I\-A\-L\-I\-Z\-E M\-A\-G\-N\-E\-T\-O\-M\-E\-T\-E\-R. 



Definition at line 53 of file mag\-\_\-functions.\-c.



References M\-A\-G\-\_\-\-C\-O\-N\-F\-I\-G\-\_\-\-A, M\-A\-G\-\_\-\-C\-O\-N\-F\-I\-G\-\_\-\-B, M\-A\-G\-\_\-\-M\-O\-D\-E, and mag\-\_\-write\-\_\-reg().



Referenced by devices\-\_\-init().


\begin{DoxyCode}
\{ 
  uint8\_t data=0;

  \textcolor{keywordflow}{switch}(rate)\{
    \textcolor{keywordflow}{case} 15:
      data=0x10;
      \textcolor{keywordflow}{break};
    \textcolor{keywordflow}{case} 0:
      data=0x00;
      \textcolor{keywordflow}{break};
    \textcolor{keywordflow}{case} 1:
      data=0x04;
      \textcolor{keywordflow}{break};
    \textcolor{keywordflow}{case} 3:
      data=0x08;
      \textcolor{keywordflow}{break};
    \textcolor{keywordflow}{case} 7:
      data=0x0C;
      \textcolor{keywordflow}{break};
    \textcolor{keywordflow}{case} 30:
      data=0x14;
      \textcolor{keywordflow}{break};
    \textcolor{keywordflow}{case} 75:
      data=0x18;
      \textcolor{keywordflow}{break};
    \textcolor{keywordflow}{default}:
      perror(\textcolor{stringliteral}{"Wrong rate value"});
      \textcolor{keywordflow}{break};
  \}
  
  \textcolor{keywordflow}{switch}(samples\_avg)\{
    \textcolor{keywordflow}{case} 8:
      data=data|0x60;
      \textcolor{keywordflow}{break};
    \textcolor{keywordflow}{case} 1:
      \textcolor{keywordflow}{break};
    \textcolor{keywordflow}{case} 2:
      data=data|0x20;
      \textcolor{keywordflow}{break};
    \textcolor{keywordflow}{case} 4:
      data=data|0x40;
      \textcolor{keywordflow}{break};
    \textcolor{keywordflow}{default}:
      perror(\textcolor{stringliteral}{"Wrong samples\_avg value"});
      \textcolor{keywordflow}{break};
  \}
  
  data+=meas\_mode;
  
  \textcolor{keywordflow}{if}(\hyperlink{communication_2imu__functions_8h_ab5d0ae421cd4bb10b1b7a1eda167416b}{mag\_write\_reg}(\hyperlink{CommunicationV0_2communication_8c_a7751bd45ac1064efb35adf1f19c25db8}{i2c\_dev}, \hyperlink{communication_2imu__regs_8h_a4c80cd6ce866f16a3d999ee2c5635ec9}{MAG\_CONFIG\_A}, data)
      <0)\{
    perror(\textcolor{stringliteral}{"Write in Configuration register A unsuccesful"});
    \textcolor{keywordflow}{return} -1;
  \}
  
  \textcolor{keywordflow}{if}(\hyperlink{communication_2imu__functions_8h_ab5d0ae421cd4bb10b1b7a1eda167416b}{mag\_write\_reg}(\hyperlink{CommunicationV0_2communication_8c_a7751bd45ac1064efb35adf1f19c25db8}{i2c\_dev}, \hyperlink{communication_2imu__regs_8h_a094173f77219df894d97eed44405d942}{MAG\_CONFIG\_B}, range
      <<5)<0)\{
    perror(\textcolor{stringliteral}{"Write in configuration register B unsuccesful"});
    \textcolor{keywordflow}{return} -1;
  \}
  
  \textcolor{keywordflow}{if}(\hyperlink{communication_2imu__functions_8h_ab5d0ae421cd4bb10b1b7a1eda167416b}{mag\_write\_reg}(\hyperlink{CommunicationV0_2communication_8c_a7751bd45ac1064efb35adf1f19c25db8}{i2c\_dev}, \hyperlink{communication_2imu__regs_8h_a0173afba6efc0e164495bf506a9758d2}{MAG\_MODE}, op\_mode)<0)\{
    perror(\textcolor{stringliteral}{"Write in mode register unsuccesful"});
    \textcolor{keywordflow}{return} -1;
  \}
  
  \textcolor{keywordflow}{return} 1;
\}
\end{DoxyCode}
\hypertarget{CommunicationV0_2mag__functions_8c_a8f2fd896caf1216ba82e535e6251692f}{\index{Communication\-V0/mag\-\_\-functions.\-c@{Communication\-V0/mag\-\_\-functions.\-c}!mag\-\_\-read\-\_\-all\-\_\-data@{mag\-\_\-read\-\_\-all\-\_\-data}}
\index{mag\-\_\-read\-\_\-all\-\_\-data@{mag\-\_\-read\-\_\-all\-\_\-data}!CommunicationV0/mag_functions.c@{Communication\-V0/mag\-\_\-functions.\-c}}
\subsubsection[{mag\-\_\-read\-\_\-all\-\_\-data}]{\setlength{\rightskip}{0pt plus 5cm}uint8\-\_\-t mag\-\_\-read\-\_\-all\-\_\-data (
\begin{DoxyParamCaption}
\item[{int}]{i2c\-\_\-dev, }
\item[{short int $\ast$}]{data}
\end{DoxyParamCaption}
)}}\label{CommunicationV0_2mag__functions_8c_a8f2fd896caf1216ba82e535e6251692f}


R\-E\-A\-D A\-L\-L D\-A\-T\-A A\-T O\-N\-C\-E (X, Y and Z) 



Definition at line 121 of file mag\-\_\-functions.\-c.



References F\-A\-I\-L\-U\-R\-E, M\-A\-G\-\_\-\-D\-A\-T\-A\-X1, mag\-\_\-read\-\_\-reg(), and S\-U\-C\-C\-E\-S\-S.



Referenced by read\-\_\-all\-\_\-data().


\begin{DoxyCode}
\{
  uint8\_t i, j;
  uint8\_t *data8;
  \textcolor{keyword}{union }result
  \{
    \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} \textcolor{keywordtype}{int} usgnd[3];
    \textcolor{keywordtype}{short} \textcolor{keywordtype}{int} sgnd[3];
  \} result;
  \textcolor{comment}{//result=(union result*)malloc(3*sizeof(union result));}
  \textcolor{keywordflow}{if}( (data8=\hyperlink{communication_2imu__functions_8h_a6830eaeae2298320e1e8c902e4edd709}{mag\_read\_reg}(\hyperlink{CommunicationV0_2communication_8c_a7751bd45ac1064efb35adf1f19c25db8}{i2c\_dev},\hyperlink{communication_2imu__regs_8h_a4f883328e7ae117996e334145ddd0032}{MAG\_DATAX1},6))==
      NULL)
  \{
    perror(\textcolor{stringliteral}{"Read accelerometer register failed"});
    \textcolor{keywordflow}{return} -1;
  \}
  \textcolor{comment}{//result.usgnd=(unsigned int*)malloc(3*sizeof(unsigned int));}
  j=0;
  \textcolor{keywordflow}{for}(i=0; i<3; i++)
  \{
    result.usgnd[j]=0;
    result.usgnd[j]=result.usgnd[j]|((\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} int)data8[i*2+1])|(((\textcolor{keywordtype}{
      unsigned} int)data8[i*2])<<8);
    data[j]=result.sgnd[j];
    j=2-i; \textcolor{comment}{// trick used to change the sorting of the data from XZY to XYZ}
  \}
  \textcolor{keywordflow}{return} result.sgnd;  
\}
\end{DoxyCode}
\hypertarget{CommunicationV0_2mag__functions_8c_a542a31ccd07cd2c3e8e2b68cdb6d219e}{\index{Communication\-V0/mag\-\_\-functions.\-c@{Communication\-V0/mag\-\_\-functions.\-c}!mag\-\_\-read\-\_\-data@{mag\-\_\-read\-\_\-data}}
\index{mag\-\_\-read\-\_\-data@{mag\-\_\-read\-\_\-data}!CommunicationV0/mag_functions.c@{Communication\-V0/mag\-\_\-functions.\-c}}
\subsubsection[{mag\-\_\-read\-\_\-data}]{\setlength{\rightskip}{0pt plus 5cm}short int mag\-\_\-read\-\_\-data (
\begin{DoxyParamCaption}
\item[{int}]{i2c\-\_\-dev, }
\item[{int}]{axis}
\end{DoxyParamCaption}
)}}\label{CommunicationV0_2mag__functions_8c_a542a31ccd07cd2c3e8e2b68cdb6d219e}


R\-E\-A\-D D\-A\-T\-A (X, Y or Z) 



Definition at line 148 of file mag\-\_\-functions.\-c.



References M\-A\-G\-\_\-\-D\-A\-T\-A\-X1, M\-A\-G\-\_\-\-D\-A\-T\-A\-Y1, M\-A\-G\-\_\-\-D\-A\-T\-A\-Z1, and mag\-\_\-read\-\_\-reg().


\begin{DoxyCode}
\{
  uint8\_t *data;
  \textcolor{keyword}{union }result
  \{
    \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} usgnd;
    \textcolor{keywordtype}{int} sgnd;
  \}result;

  \textcolor{keywordflow}{switch}(axis)\{
    \textcolor{keywordflow}{case} \textcolor{charliteral}{'X'}:
      data=\hyperlink{communication_2imu__functions_8h_a6830eaeae2298320e1e8c902e4edd709}{mag\_read\_reg}(\hyperlink{CommunicationV0_2communication_8c_a7751bd45ac1064efb35adf1f19c25db8}{i2c\_dev},\hyperlink{communication_2imu__regs_8h_a4f883328e7ae117996e334145ddd0032}{MAG\_DATAX1},2);
      \textcolor{keywordflow}{break};
    \textcolor{keywordflow}{case} \textcolor{charliteral}{'Y'}:
      data=\hyperlink{communication_2imu__functions_8h_a6830eaeae2298320e1e8c902e4edd709}{mag\_read\_reg}(\hyperlink{CommunicationV0_2communication_8c_a7751bd45ac1064efb35adf1f19c25db8}{i2c\_dev},\hyperlink{communication_2imu__regs_8h_ae218906702b1e40c2b6970f97dd0cfe4}{MAG\_DATAY1},2);
      \textcolor{keywordflow}{break};
    \textcolor{keywordflow}{case} \textcolor{charliteral}{'Z'}:
      data=\hyperlink{communication_2imu__functions_8h_a6830eaeae2298320e1e8c902e4edd709}{mag\_read\_reg}(\hyperlink{CommunicationV0_2communication_8c_a7751bd45ac1064efb35adf1f19c25db8}{i2c\_dev},\hyperlink{communication_2imu__regs_8h_a81d7d9236ec69a1a229e4fa7c6299fde}{MAG\_DATAZ1},2);
      \textcolor{keywordflow}{break};
    \textcolor{keywordflow}{default}:
      perror(\textcolor{stringliteral}{"Wrong argument for axis in mag\_read\_data"});
      \textcolor{keywordflow}{return} -1;
  \}
  result.usgnd=0;
  result.usgnd=result.usgnd|(((\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} int)data[1]))|(((\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} \textcolor{keywordtype}{
      int})data[0])<<8);
  \textcolor{keywordflow}{return} result.sgnd;
\}\end{DoxyCode}
\hypertarget{CommunicationV0_2mag__functions_8c_a6830eaeae2298320e1e8c902e4edd709}{\index{Communication\-V0/mag\-\_\-functions.\-c@{Communication\-V0/mag\-\_\-functions.\-c}!mag\-\_\-read\-\_\-reg@{mag\-\_\-read\-\_\-reg}}
\index{mag\-\_\-read\-\_\-reg@{mag\-\_\-read\-\_\-reg}!CommunicationV0/mag_functions.c@{Communication\-V0/mag\-\_\-functions.\-c}}
\subsubsection[{mag\-\_\-read\-\_\-reg}]{\setlength{\rightskip}{0pt plus 5cm}uint8\-\_\-t$\ast$ mag\-\_\-read\-\_\-reg (
\begin{DoxyParamCaption}
\item[{int}]{i2c\-\_\-dev, }
\item[{uint8\-\_\-t}]{reg, }
\item[{uint8\-\_\-t}]{count}
\end{DoxyParamCaption}
)}}\label{CommunicationV0_2mag__functions_8c_a6830eaeae2298320e1e8c902e4edd709}


R\-E\-A\-D C\-O\-U\-N\-T 8-\/\-B\-I\-T R\-E\-G\-I\-S\-T\-E\-R I\-N S\-E\-Q\-U\-E\-N\-C\-E. 


\begin{DoxyParams}{Parameters}
{\em count} & number of registers in sequence (1-\/13) \\
\hline
\end{DoxyParams}


Definition at line 31 of file mag\-\_\-functions.\-c.



Referenced by mag\-\_\-read\-\_\-all\-\_\-data(), and mag\-\_\-read\-\_\-data().


\begin{DoxyCode}
\{
  uint8\_t data[13];
  \textcolor{keywordtype}{int} i;

  \textcolor{comment}{//data=(uint8\_t*)malloc((count+1)*sizeof(data));}
  
  data[0] = reg;

  \textcolor{keywordflow}{if} (write(\hyperlink{CommunicationV0_2communication_8c_a7751bd45ac1064efb35adf1f19c25db8}{i2c\_dev}, &data, 1) != 1) \{            
        perror(\textcolor{stringliteral}{"write before read"});
        \textcolor{keywordflow}{return} NULL;
  \}
  data[0] = 0;
  \textcolor{keywordflow}{if} (read(\hyperlink{CommunicationV0_2communication_8c_a7751bd45ac1064efb35adf1f19c25db8}{i2c\_dev}, &data, count) != count) \{
        perror(\textcolor{stringliteral}{"read"});
        \textcolor{keywordflow}{return} NULL;    
  \}

  \textcolor{keywordflow}{return} data;
\}
\end{DoxyCode}
\hypertarget{CommunicationV0_2mag__functions_8c_ab5d0ae421cd4bb10b1b7a1eda167416b}{\index{Communication\-V0/mag\-\_\-functions.\-c@{Communication\-V0/mag\-\_\-functions.\-c}!mag\-\_\-write\-\_\-reg@{mag\-\_\-write\-\_\-reg}}
\index{mag\-\_\-write\-\_\-reg@{mag\-\_\-write\-\_\-reg}!CommunicationV0/mag_functions.c@{Communication\-V0/mag\-\_\-functions.\-c}}
\subsubsection[{mag\-\_\-write\-\_\-reg}]{\setlength{\rightskip}{0pt plus 5cm}int mag\-\_\-write\-\_\-reg (
\begin{DoxyParamCaption}
\item[{int}]{i2c\-\_\-dev, }
\item[{uint8\-\_\-t}]{reg, }
\item[{uint8\-\_\-t}]{data}
\end{DoxyParamCaption}
)}}\label{CommunicationV0_2mag__functions_8c_ab5d0ae421cd4bb10b1b7a1eda167416b}


W\-R\-I\-T\-E T\-O R\-E\-G\-I\-S\-T\-E\-R. 

Rev 0 -\/ 11/11/2012 R\-L\-E\-G project -\/ 2012.

W\-R\-I\-T\-E T\-O R\-E\-G\-I\-S\-T\-E\-R.

Implements the I2\-C communication between Gumstix Overo Fire and H\-M\-C5883 \begin{DoxyAuthor}{Author}
Caio Gustavo Mesquita Ângelo 
\end{DoxyAuthor}


Definition at line 10 of file mag\-\_\-functions.\-c.



References M\-A\-G\-\_\-\-M\-O\-D\-E.



Referenced by mag\-\_\-init().


\begin{DoxyCode}
\{
  uint8\_t reg\_data[2];

  reg\_data[0] = reg;
  reg\_data[1] = data;

  \textcolor{keywordflow}{if}( \hyperlink{communication_2imu__regs_8h_a0173afba6efc0e164495bf506a9758d2}{MAG\_MODE}<reg )
  \{
      perror(\textcolor{stringliteral}{"Write unsucessful: Not a valid writable register"});
      \textcolor{keywordflow}{return} -1;
  \}
        
  \textcolor{keywordflow}{if} (write(\hyperlink{CommunicationV0_2communication_8c_a7751bd45ac1064efb35adf1f19c25db8}{i2c\_dev}, &reg\_data, 2) != 2) \{                
          perror(\textcolor{stringliteral}{"Write unsuccessful"});
          \textcolor{keywordflow}{return} -1;
  \}

  \textcolor{keywordflow}{return} 1;
\}
\end{DoxyCode}
