\hypertarget{CommunicationV0_2spi__functions_8c}{\section{Communication\-V0/spi\-\_\-functions.c File Reference}
\label{CommunicationV0_2spi__functions_8c}\index{Communication\-V0/spi\-\_\-functions.\-c@{Communication\-V0/spi\-\_\-functions.\-c}}
}
{\ttfamily \#include \char`\"{}spi\-\_\-functions.\-h\char`\"{}}\\*
Include dependency graph for spi\-\_\-functions.\-c\-:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{CommunicationV0_2spi__functions_8c__incl}
\end{center}
\end{figure}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
int \hyperlink{CommunicationV0_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{pabort} (const char $\ast$s)
\item 
int \hyperlink{CommunicationV0_2spi__functions_8c_a70764aca888e93b0329e7a62c9312704}{spi\-\_\-init} (uint8\-\_\-t mode, uint32\-\_\-t speed, uint8\-\_\-t cs)
\begin{DoxyCompactList}\small\item\em spi Functions to deal communication by S\-P\-I protocol \end{DoxyCompactList}\item 
void \hyperlink{CommunicationV0_2spi__functions_8c_a3fb02c6fc5990df81645306a81291624}{spi\-\_\-end} (int \hyperlink{CommunicationV0_2communication_8c_a4788f0a5355494bc6c13690e28f43783}{spi\-\_\-dev})
\begin{DoxyCompactList}\small\item\em T\-E\-R\-M\-I\-N\-A\-T\-E\-S S\-P\-I D\-E\-V\-I\-C\-E. \end{DoxyCompactList}\item 
short int \hyperlink{CommunicationV0_2spi__functions_8c_a405e3e13b63a628c1be12ccba7e2ebbf}{adc\-\_\-read} (int \hyperlink{CommunicationV0_2communication_8c_a4788f0a5355494bc6c13690e28f43783}{spi\-\_\-dev}, uint8\-\_\-t ch, uint8\-\_\-t sgl)
\item 
uint8\-\_\-t \hyperlink{CommunicationV0_2spi__functions_8c_a9fe5e6b0c564de89398a80e1689b717f}{dac\-\_\-write} (int \hyperlink{CommunicationV0_2communication_8c_a4788f0a5355494bc6c13690e28f43783}{spi\-\_\-dev}, uint8\-\_\-t ch, uint8\-\_\-t \-\_\-shdn, unsigned short int data)
\begin{DoxyCompactList}\small\item\em W\-R\-I\-T\-E D\-A\-T\-A T\-O D/\-A C\-O\-N\-V\-E\-R\-T\-E\-R M\-C\-P3922. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
static uint8\-\_\-t \hyperlink{CommunicationV0_2spi__functions_8c_a46a6da6b1936191571fd30b2a749f38c}{bits} = 8
\item 
static uint16\-\_\-t \hyperlink{CommunicationV0_2spi__functions_8c_adc4674f6ea53803d98fa2ec36759e77d}{delay}
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\hypertarget{CommunicationV0_2spi__functions_8c_a405e3e13b63a628c1be12ccba7e2ebbf}{\index{Communication\-V0/spi\-\_\-functions.\-c@{Communication\-V0/spi\-\_\-functions.\-c}!adc\-\_\-read@{adc\-\_\-read}}
\index{adc\-\_\-read@{adc\-\_\-read}!CommunicationV0/spi_functions.c@{Communication\-V0/spi\-\_\-functions.\-c}}
\subsubsection[{adc\-\_\-read}]{\setlength{\rightskip}{0pt plus 5cm}short int adc\-\_\-read (
\begin{DoxyParamCaption}
\item[{int}]{spi\-\_\-dev, }
\item[{uint8\-\_\-t}]{ch, }
\item[{uint8\-\_\-t}]{sgl}
\end{DoxyParamCaption}
)}}\label{CommunicationV0_2spi__functions_8c_a405e3e13b63a628c1be12ccba7e2ebbf}


Definition at line 165 of file spi\-\_\-functions.\-c.



References A\-R\-R\-A\-Y\-\_\-\-S\-I\-Z\-E, delay, and pabort().


\begin{DoxyCode}
166 \{
167         \textcolor{keywordtype}{int} ret;
168         \textcolor{keywordflow}{if}( ch<0 || ch>7 ) \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{pabort}(\textcolor{stringliteral}{"Wrong channel value for ADC"});
169         uint8\_t tx[] = \{(ch>>2)|(sgl<<1)|0x04, ch<<6, 0x00,\};
170         uint8\_t rx[\hyperlink{communication_2spi__functions_8h_a25f003de16c08a4888b69f619d70f427}{ARRAY\_SIZE}(tx)] = \{0, \};
171         \textcolor{keyword}{struct }spi\_ioc\_transfer tr = \{
172                 .tx\_buf = (\textcolor{keywordtype}{unsigned} long)tx,
173                 .rx\_buf = (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long})rx,
174                 .len = \hyperlink{communication_2spi__functions_8h_a25f003de16c08a4888b69f619d70f427}{ARRAY\_SIZE}(tx),
175                 .delay\_usecs = \hyperlink{CommunicationV0_2spi__functions_8c_adc4674f6ea53803d98fa2ec36759e77d}{delay},
176                 .speed\_hz = 0,
177                 .bits\_per\_word = 0,
178         \};
179 
180         ret = ioctl(\hyperlink{CommunicationV0_2communication_8c_a4788f0a5355494bc6c13690e28f43783}{spi\_dev}, SPI\_IOC\_MESSAGE(1), &tr);
181         \textcolor{keywordflow}{if} (ret == 1) \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{pabort}(\textcolor{stringliteral}{"can't send spi message"});
182 \textcolor{comment}{//printf("\(\backslash\)nRx = 0x%X 0x%X 0x%X\(\backslash\)n",rx[0],rx[1],rx[2]);}
183 \textcolor{comment}{//printf("\(\backslash\)nValor retornado pelo conversor AD: %d\(\backslash\)n\(\backslash\)n",rx[2]+((rx[1]&0x0F)<<8));}
184         \textcolor{keywordflow}{return} rx[2]+((rx[1]&0x0F)<<8);
185 \}
\end{DoxyCode}


Here is the call graph for this function\-:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=216pt]{CommunicationV0_2spi__functions_8c_a405e3e13b63a628c1be12ccba7e2ebbf_cgraph}
\end{center}
\end{figure}


\hypertarget{CommunicationV0_2spi__functions_8c_a9fe5e6b0c564de89398a80e1689b717f}{\index{Communication\-V0/spi\-\_\-functions.\-c@{Communication\-V0/spi\-\_\-functions.\-c}!dac\-\_\-write@{dac\-\_\-write}}
\index{dac\-\_\-write@{dac\-\_\-write}!CommunicationV0/spi_functions.c@{Communication\-V0/spi\-\_\-functions.\-c}}
\subsubsection[{dac\-\_\-write}]{\setlength{\rightskip}{0pt plus 5cm}uint8\-\_\-t dac\-\_\-write (
\begin{DoxyParamCaption}
\item[{int}]{spi\-\_\-dev, }
\item[{uint8\-\_\-t}]{ch, }
\item[{uint8\-\_\-t}]{\-\_\-shdn, }
\item[{unsigned short int}]{data}
\end{DoxyParamCaption}
)}}\label{CommunicationV0_2spi__functions_8c_a9fe5e6b0c564de89398a80e1689b717f}


W\-R\-I\-T\-E D\-A\-T\-A T\-O D/\-A C\-O\-N\-V\-E\-R\-T\-E\-R M\-C\-P3922. 



Definition at line 187 of file spi\-\_\-functions.\-c.



References A\-R\-R\-A\-Y\-\_\-\-S\-I\-Z\-E, delay, F\-A\-I\-L\-U\-R\-E, and pabort().


\begin{DoxyCode}
188 \{
189         \textcolor{keywordtype}{int} ret;
190         \textcolor{keyword}{union }txunion\{
191         \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} \textcolor{keywordtype}{int} data16;
192         uint8\_t data8[2];
193         \}txunion;
194         \textcolor{keywordflow}{if}( ch<0 || ch>1 ) \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{pabort}(\textcolor{stringliteral}{"Wrong channel value for DAC"});
195         \textcolor{keywordflow}{if}( data>4095 ) \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{pabort}(\textcolor{stringliteral}{"Value exceeded for DAC"}); 
196         txunion.data16 = 0x6000|(ch<<15)|(\_shdn<<12)|(data&0x0FFF);
197         uint8\_t tx[] = \{txunion.data8[0], txunion.data8[1]\};
198         uint8\_t rx[\hyperlink{communication_2spi__functions_8h_a25f003de16c08a4888b69f619d70f427}{ARRAY\_SIZE}(tx)] = \{0, \};
199         \textcolor{keyword}{struct }spi\_ioc\_transfer tr = \{
200                 .tx\_buf = (\textcolor{keywordtype}{unsigned} long)tx,
201                 .rx\_buf = (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long})rx,
202                 .len = \hyperlink{communication_2spi__functions_8h_a25f003de16c08a4888b69f619d70f427}{ARRAY\_SIZE}(tx),
203                 .delay\_usecs = \hyperlink{CommunicationV0_2spi__functions_8c_adc4674f6ea53803d98fa2ec36759e77d}{delay},
204                 .speed\_hz = 0,
205                 .bits\_per\_word = 0,
206         \};
207 
208         ret = ioctl(\hyperlink{CommunicationV0_2communication_8c_a4788f0a5355494bc6c13690e28f43783}{spi\_dev}, SPI\_IOC\_MESSAGE(1), &tr);
209         \textcolor{keywordflow}{if} (ret == 1) \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{pabort}(\textcolor{stringliteral}{"can't send spi message"});
210 \textcolor{comment}{//printf("\(\backslash\)nRx = 0x%X 0x%X 0x%X\(\backslash\)n",rx[0],rx[1],rx[2]);}
211 \textcolor{comment}{//printf("\(\backslash\)nValor retornado pelo conversor AD: %d\(\backslash\)n\(\backslash\)n",rx[2]+((rx[1]&0x0F)<<8));}
212         \textcolor{keywordflow}{return} 1;
213 \}
\end{DoxyCode}


Here is the call graph for this function\-:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=220pt]{CommunicationV0_2spi__functions_8c_a9fe5e6b0c564de89398a80e1689b717f_cgraph}
\end{center}
\end{figure}


\hypertarget{CommunicationV0_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{\index{Communication\-V0/spi\-\_\-functions.\-c@{Communication\-V0/spi\-\_\-functions.\-c}!pabort@{pabort}}
\index{pabort@{pabort}!CommunicationV0/spi_functions.c@{Communication\-V0/spi\-\_\-functions.\-c}}
\subsubsection[{pabort}]{\setlength{\rightskip}{0pt plus 5cm}int pabort (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{s}
\end{DoxyParamCaption}
)}}\label{CommunicationV0_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}


Definition at line 7 of file spi\-\_\-functions.\-c.


\begin{DoxyCode}
8 \{
9         perror(s);
10         \textcolor{keywordflow}{return} -1;
11 \}
\end{DoxyCode}
\hypertarget{CommunicationV0_2spi__functions_8c_a3fb02c6fc5990df81645306a81291624}{\index{Communication\-V0/spi\-\_\-functions.\-c@{Communication\-V0/spi\-\_\-functions.\-c}!spi\-\_\-end@{spi\-\_\-end}}
\index{spi\-\_\-end@{spi\-\_\-end}!CommunicationV0/spi_functions.c@{Communication\-V0/spi\-\_\-functions.\-c}}
\subsubsection[{spi\-\_\-end}]{\setlength{\rightskip}{0pt plus 5cm}void spi\-\_\-end (
\begin{DoxyParamCaption}
\item[{int}]{spi\-\_\-dev}
\end{DoxyParamCaption}
)}}\label{CommunicationV0_2spi__functions_8c_a3fb02c6fc5990df81645306a81291624}


T\-E\-R\-M\-I\-N\-A\-T\-E\-S S\-P\-I D\-E\-V\-I\-C\-E. 



Definition at line 159 of file spi\-\_\-functions.\-c.


\begin{DoxyCode}
160 \{
161   close(\hyperlink{CommunicationV0_2communication_8c_a4788f0a5355494bc6c13690e28f43783}{spi\_dev});
162   \textcolor{keywordflow}{return};
163 \}
\end{DoxyCode}
\hypertarget{CommunicationV0_2spi__functions_8c_a70764aca888e93b0329e7a62c9312704}{\index{Communication\-V0/spi\-\_\-functions.\-c@{Communication\-V0/spi\-\_\-functions.\-c}!spi\-\_\-init@{spi\-\_\-init}}
\index{spi\-\_\-init@{spi\-\_\-init}!CommunicationV0/spi_functions.c@{Communication\-V0/spi\-\_\-functions.\-c}}
\subsubsection[{spi\-\_\-init}]{\setlength{\rightskip}{0pt plus 5cm}int spi\-\_\-init (
\begin{DoxyParamCaption}
\item[{uint8\-\_\-t}]{mode, }
\item[{uint32\-\_\-t}]{speed, }
\item[{uint8\-\_\-t}]{cs}
\end{DoxyParamCaption}
)}}\label{CommunicationV0_2spi__functions_8c_a70764aca888e93b0329e7a62c9312704}


spi Functions to deal communication by S\-P\-I protocol 

I\-N\-I\-T\-I\-A\-L\-I\-Z\-E S\-P\-I D\-E\-V\-I\-C\-E 

Definition at line 96 of file spi\-\_\-functions.\-c.



References bits, pabort(), and spi\-\_\-dev.


\begin{DoxyCode}
97 \{
98         \textcolor{keywordtype}{int} ret = 0;
99         \textcolor{keywordtype}{int} \hyperlink{CommunicationV0_2communication_8c_a4788f0a5355494bc6c13690e28f43783}{spi\_dev};
100         \textcolor{keywordtype}{char} *device;
101 
102         \textcolor{comment}{//parse\_opts(argc, argv);}
103         \textcolor{keywordflow}{switch}(cs)\{
104           \textcolor{keywordflow}{case} 0:
105             device = \textcolor{stringliteral}{"/dev/spidev1.0"};
106             \textcolor{keywordflow}{break};
107           \textcolor{keywordflow}{case} 1:
108             device = \textcolor{stringliteral}{"/dev/spidev1.1"};
109             \textcolor{keywordflow}{break};
110           \textcolor{keywordflow}{default}:
111             \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{pabort}(\textcolor{stringliteral}{"invalid chip select value"});
112         \}
113             
114         
115         spi\_dev = open(device, O\_RDWR);
116         \textcolor{keywordflow}{if} (spi\_dev < 0)
117                 \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{pabort}(\textcolor{stringliteral}{"can't open device"});
118 printf(\textcolor{stringliteral}{"\(\backslash\)nspi\_dev = %d\(\backslash\)n"},spi\_dev);
119         \textcolor{comment}{/*}
120 \textcolor{comment}{         * spi mode}
121 \textcolor{comment}{         */}
122         ret = ioctl(spi\_dev, SPI\_IOC\_WR\_MODE, &mode);
123         \textcolor{keywordflow}{if} (ret == -1)
124                 \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{pabort}(\textcolor{stringliteral}{"can't set spi mode"});
125 
126         ret = ioctl(spi\_dev, SPI\_IOC\_RD\_MODE, &mode);
127         \textcolor{keywordflow}{if} (ret == -1)
128                 \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{pabort}(\textcolor{stringliteral}{"can't get spi mode"});
129 
130         \textcolor{comment}{/*}
131 \textcolor{comment}{         * bits per word}
132 \textcolor{comment}{         */}
133         ret = ioctl(spi\_dev, SPI\_IOC\_WR\_BITS\_PER\_WORD, &\hyperlink{CommunicationV0_2spi__functions_8c_a46a6da6b1936191571fd30b2a749f38c}{bits});
134         \textcolor{keywordflow}{if} (ret == -1)
135                 \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{pabort}(\textcolor{stringliteral}{"can't set bits per word"});
136 
137         ret = ioctl(spi\_dev, SPI\_IOC\_RD\_BITS\_PER\_WORD, &\hyperlink{CommunicationV0_2spi__functions_8c_a46a6da6b1936191571fd30b2a749f38c}{bits});
138         \textcolor{keywordflow}{if} (ret == -1)
139                 \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{pabort}(\textcolor{stringliteral}{"can't get bits per word"});
140 
141         \textcolor{comment}{/*}
142 \textcolor{comment}{         * max speed hz}
143 \textcolor{comment}{         */}
144         ret = ioctl(spi\_dev, SPI\_IOC\_WR\_MAX\_SPEED\_HZ, &speed);
145         \textcolor{keywordflow}{if} (ret == -1)
146                 \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{pabort}(\textcolor{stringliteral}{"can't set max speed hz"});
147 
148         ret = ioctl(spi\_dev, SPI\_IOC\_RD\_MAX\_SPEED\_HZ, &speed);
149         \textcolor{keywordflow}{if} (ret == -1)
150                 \textcolor{keywordflow}{return} \hyperlink{communication_2spi__functions_8c_aabfca8320b0c76774f01467703e17302}{pabort}(\textcolor{stringliteral}{"can't get max speed hz"});
151 
152         \textcolor{comment}{//printf("spi mode: %d\(\backslash\)n", mode);}
153         \textcolor{comment}{//printf("bits per word: %d\(\backslash\)n", bits);}
154         \textcolor{comment}{//printf("max speed: %d Hz (%d KHz)\(\backslash\)n", speed, speed/1000);}
155 
156         \textcolor{keywordflow}{return} \hyperlink{CommunicationV0_2communication_8c_a4788f0a5355494bc6c13690e28f43783}{spi\_dev};
157 \}
\end{DoxyCode}


Here is the call graph for this function\-:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=208pt]{CommunicationV0_2spi__functions_8c_a70764aca888e93b0329e7a62c9312704_cgraph}
\end{center}
\end{figure}




\subsection{Variable Documentation}
\hypertarget{CommunicationV0_2spi__functions_8c_a46a6da6b1936191571fd30b2a749f38c}{\index{Communication\-V0/spi\-\_\-functions.\-c@{Communication\-V0/spi\-\_\-functions.\-c}!bits@{bits}}
\index{bits@{bits}!CommunicationV0/spi_functions.c@{Communication\-V0/spi\-\_\-functions.\-c}}
\subsubsection[{bits}]{\setlength{\rightskip}{0pt plus 5cm}uint8\-\_\-t bits = 8\hspace{0.3cm}{\ttfamily [static]}}}\label{CommunicationV0_2spi__functions_8c_a46a6da6b1936191571fd30b2a749f38c}


Definition at line 14 of file spi\-\_\-functions.\-c.



Referenced by spi\-\_\-init().

\hypertarget{CommunicationV0_2spi__functions_8c_adc4674f6ea53803d98fa2ec36759e77d}{\index{Communication\-V0/spi\-\_\-functions.\-c@{Communication\-V0/spi\-\_\-functions.\-c}!delay@{delay}}
\index{delay@{delay}!CommunicationV0/spi_functions.c@{Communication\-V0/spi\-\_\-functions.\-c}}
\subsubsection[{delay}]{\setlength{\rightskip}{0pt plus 5cm}uint16\-\_\-t delay\hspace{0.3cm}{\ttfamily [static]}}}\label{CommunicationV0_2spi__functions_8c_adc4674f6ea53803d98fa2ec36759e77d}


Definition at line 16 of file spi\-\_\-functions.\-c.



Referenced by adc\-\_\-read(), and dac\-\_\-write().

